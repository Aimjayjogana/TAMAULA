{% extends "base.html" %}

{% block title %}Edit Profile - TAMAULA{% endblock %}

{% block content %}
<div class="dashboard-content">
    <div class="dashboard-header">
        <h1>Edit Profile Details</h1>
        <p>Update your personal information and club affiliation</p>
    </div>

    <div class="form-container">
        <form method="POST" enctype="multipart/form-data">
            <!-- Profile Picture Section -->
            <div style="text-align: center; margin-bottom: 2rem;">
                <img id="profilePreview" 
                     src="{% if player.profile_picture %}{{ player.profile_picture }}{% else %}{{ url_for('static', filename='images/default-player.jpg') }}{% endif %}" 
                     alt="Profile Preview" 
                     style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">
                
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="profile_picture">Change Profile Picture</label>
                    <input type="file" id="profile_picture" name="profile_picture" class="form-control" accept="image/*" data-preview="profilePreview">
                    <small style="color: var(--gray); font-size: 0.8rem;">
                        Recommended: Square image, max 5MB (JPEG, PNG, WebP)
                    </small>
                </div>
            </div>
            
            <!-- Personal Information -->
            <div class="form-group">
                <label for="fullname">Full Name *</label>
                <input type="text" id="fullname" name="fullname" class="form-control" value="{{ player.fullname }}" required>
            </div>
            
            <div class="form-group">
                <label for="username">Username *</label>
                <input type="text" id="username" name="username" class="form-control" value="{{ player.username }}" required>
                <small style="color: var(--gray); font-size: 0.8rem;">
                    This will be your public display name
                </small>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" class="form-control" value="{{ player.email }}" required>
            </div>
            
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" class="form-control" value="{{ player.phone or '' }}" placeholder="+234 XXX XXX XXXX">
            </div>
            
            <div class="form-group">
                <label for="date_of_birth">Date of Birth *</label>
                <input type="date" id="date_of_birth" name="date_of_birth" class="form-control" value="{{ player.date_of_birth }}" required>
            </div>
            
            <div class="form-group">
                <label for="jersey_number">Jersey Number</label>
                <input type="number" id="jersey_number" name="jersey_number" class="form-control" value="{{ player.jersey_number or '' }}" min="1" max="99" placeholder="1-99">
            </div>
            
            <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender" class="form-control">
                    <option value="">Select Gender</option>
                    <option value="Male" {% if player.gender == 'Male' %}selected{% endif %}>Male</option>
                    <option value="Female" {% if player.gender == 'Female' %}selected{% endif %}>Female</option>
                    <option value="Other" {% if player.gender == 'Other' %}selected{% endif %}>Other</option>
                    <option value="Prefer not to say" {% if player.gender == 'Prefer not to say' %}selected{% endif %}>Prefer not to say</option>
                </select>
            </div>

            <!-- Club Selection Section - THIS IS THE MISSING FIELD -->
            <div class="form-group">
    <label for="club_id">Transfer to New Club</label>
    <select id="club_id" name="club_id" class="form-control">
        <option value="{{ player.club_id }}">Stay with {{ player.club_name }}</option>
        {% for club in clubs %}
        {% if club.id != player.club_id %}
        <option value="{{ club.id }}">
            {{ club.name }} - {{ club.local_government }}
        </option>
        {% endif %}
        {% endfor %}
    </select>
    <small style="color: var(--gray); font-size: 0.8rem;">
        Changing clubs requires approval from both clubs
    </small>
</div>

<!-- Transfer Reason (shown only when changing clubs) -->
<div id="transferSection" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
    <div class="form-group">
        <label for="transfer_reason">Reason for Transfer (Optional)</label>
        <textarea id="transfer_reason" name="transfer_reason" class="form-control" rows="3" placeholder="Why do you want to transfer?"></textarea>
    </div>
</div>

            <!-- Password Change Section -->
            <div style="border-top: 2px solid #e2e8f0; padding-top: 2rem; margin-top: 1rem;">
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Security Settings</h3>
                
                <div class="form-group">
                    <label for="current_password">Current Password *</label>
                    <input type="password" id="current_password" name="current_password" class="form-control" required>
                    <small style="color: var(--gray); font-size: 0.8rem;">
                        Required to confirm any changes to your profile
                    </small>
                </div>

                <div class="form-group">
                    <label for="new_password">New Password (leave blank to keep current)</label>
                    <input type="password" id="new_password" name="new_password" class="form-control">
                    <small style="color: var(--gray); font-size: 0.8rem;">
                        Minimum 8 characters with letters and numbers
                    </small>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" class="form-control">
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                <button type="submit" class="btn" style="background: var(--success);">
                    Update Profile
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn" style="background: var(--gray);">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Image preview functionality
document.getElementById('profile_picture').addEventListener('change', function() {
    const preview = document.getElementById('profilePreview');
    const file = this.files[0];
    
    if (file) {
        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            this.value = '';
            return;
        }
        
        // Check file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('Please select a valid image file (JPEG, PNG, or WebP)');
            this.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Password confirmation validation
document.querySelector('form').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    // Validate password match
    if (newPassword && newPassword !== confirmPassword) {
        e.preventDefault();
        alert('New password and confirmation do not match!');
        document.getElementById('confirm_password').focus();
        return;
    }
    
    // Validate password strength
    if (newPassword && newPassword.length < 8) {
        e.preventDefault();
        alert('New password must be at least 8 characters long!');
        document.getElementById('new_password').focus();
        return;
    }
});

// Show transfer reason when changing clubs
document.getElementById('club_id').addEventListener('change', function() {
    const transferSection = document.getElementById('transferSection');
    if (this.value != "{{ player.club_id }}") {
        transferSection.style.display = 'block';
    } else {
        transferSection.style.display = 'none';
    }
});
</script>
{% endblock %}