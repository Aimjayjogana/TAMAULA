{% extends "base.html" %}

{% block title %}Group Matches - {{ competition.name }} - TAMAULA{% endblock %}

{% block content %}
<div class="dashboard-content">
    <div class="dashboard-header">
        <h1>Group Stage Matches: {{ competition.name }}</h1>
        <p>Manage matches and standings for group stage</p>
    </div>

    {% for group in groups %}
    <div class="card" style="margin-bottom: 2rem;">
        <h2>{{ group.group_name }}</h2>
        
        <!-- Group Standings -->
        <h3>Standings</h3>
        {% if group_standings[group.id] %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Club</th>
                        <th>MP</th>
                        <th>W</th>
                        <th>D</th>
                        <th>L</th>
                        <th>GF</th>
                        <th>GA</th>
                        <th>GD</th>
                        <th>Pts</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for standing in group_standings[group.id] %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                {% if standing.logo %}
                                <img src="{{ standing.logo }}" 
                                     alt="{{ standing.club_name }}" style="width: 25px; height: 25px; border-radius: 50%;">
                                {% endif %}
                                {{ standing.club_name }}
                            </div>
                        </td>
                        <td>{{ standing.matches_played }}</td>
                        <td>{{ standing.wins }}</td>
                        <td>{{ standing.draws }}</td>
                        <td>{{ standing.losses }}</td>
                        <td>{{ standing.goals_for }}</td>
                        <td>{{ standing.goals_against }}</td>
                        <td>{{ standing.goals_for - standing.goals_against }}</td>
                        <td><strong>{{ standing.points }}</strong></td>
                        <td>
                            <span class="badge" style="
                                background: {% if standing.status == 'qualified' %}var(--success)
                                           {% elif standing.status == 'eliminated' %}var(--error)
                                           {% else %}var(--warning){% endif %};
                                color: white; padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem;">
                                {{ standing.status|title }}
                            </span>
                        </td>
                        <td>
                            <select onchange="updateEliminationStatus({{ standing.id }}, this.value)" 
                                    style="padding: 0.25rem; border-radius: 3px; border: 1px solid #e2e8f0;">
                                <option value="active" {% if standing.status == 'active' %}selected{% endif %}>Active</option>
                                <option value="qualified" {% if standing.status == 'qualified' %}selected{% endif %}>Qualified</option>
                                <option value="eliminated" {% if standing.status == 'eliminated' %}selected{% endif %}>Eliminated</option>
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="text-align: center; padding: 2rem; color: var(--gray);">
            No clubs in this group yet
        </p>
        {% endif %}

        <!-- Group Matches -->
        <h3 style="margin-top: 2rem;">Matches</h3>
        
        <!-- Create Match Form -->
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 5px; margin-bottom: 1.5rem;">
            <h4>Create New Match</h4>
            <form class="createMatchForm" data-group-id="{{ group.id }}">
                <input type="hidden" name="competition_id" value="{{ competition.id }}">
                <input type="hidden" name="group_id" value="{{ group.id }}">
                
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: end;">
                    <div class="form-group">
                        <label>Home Team</label>
                        <select name="home_club_id" class="form-control" required>
                            <option value="">Select home team</option>
                            {% for standing in group_standings[group.id] %}
                            <option value="{{ standing.club_id }}">{{ standing.club_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div style="text-align: center; padding-bottom: 1rem;">
                        <strong>VS</strong>
                    </div>
                    
                    <div class="form-group">
                        <label>Away Team</label>
                        <select name="away_club_id" class="form-control" required>
                            <option value="">Select away team</option>
                            {% for standing in group_standings[group.id] %}
                            <option value="{{ standing.club_id }}">{{ standing.club_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div class="form-group">
                        <label>Match Date</label>
                        <input type="date" name="match_date" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Match Time</label>
                        <input type="time" name="match_time" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="location" class="form-control" placeholder="Match venue">
                    </div>
                </div>
                
                <button type="submit" class="btn">Create Match</button>
            </form>
        </div>

        <!-- Matches List -->
        {% if group_matches[group.id] %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Match</th>
                        <th>Date & Time</th>
                        <th>Location</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in group_matches[group.id] %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                {% if match.home_logo %}
                                <img src="{{ match.home_logo }}" 
                                     alt="{{ match.home_club_name }}" style="width: 25px; height: 25px; border-radius: 50%;">
                                {% endif %}
                                {{ match.home_club_name }}
                                <strong> vs </strong>
                                {% if match.away_logo %}
                                <img src="{{ match.away_logo }}" 
                                     alt="{{ match.away_club_name }}" style="width: 25px; height: 25px; border-radius: 50%;">
                                {% endif %}
                                {{ match.away_club_name }}
                            </div>
                        </td>
                        <td>
                            {{ match.match_date }}<br>
                            <small>{{ match.match_time if match.match_time else 'TBD' }}</small>
                        </td>
                        <td>{{ match.location or 'TBD' }}</td>
                        <td>
                            {% if match.status == 'completed' %}
                            <strong>{{ match.home_score }} - {{ match.away_score }}</strong>
                            {% else %}
                            <em>Not played</em>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge" style="
                                background: {% if match.status == 'completed' %}var(--success)
                                           {% elif match.status == 'ongoing' %}var(--warning)
                                           {% else %}var(--gray){% endif %};
                                color: white; padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem;">
                                {{ match.status|title }}
                            </span>
                        </td>
                        <td>
                            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                    onclick="openScoreModal({{ match.id }}, {{ match.home_score }}, {{ match.away_score }}, '{{ match.status }}')">
                                Update Score
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="text-align: center; padding: 2rem; color: var(--gray);">
            No matches scheduled for this group yet
        </p>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Score Update Modal -->
<div id="scoreModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px;">
        <h3>Update Match Score</h3>
        <form id="scoreForm">
            <input type="hidden" id="match_id" name="match_id">
            
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: center; text-align: center; margin: 1.5rem 0;">
                <div>
                    <label>Home Score</label>
                    <input type="number" id="home_score" name="home_score" class="form-control" min="0" value="0" required>
                </div>
                <div>
                    <strong>VS</strong>
                </div>
                <div>
                    <label>Away Score</label>
                    <input type="number" id="away_score" name="away_score" class="form-control" min="0" value="0" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Match Status</label>
                <select id="match_status" name="status" class="form-control" required>
                    <option value="scheduled">Scheduled</option>
                    <option value="ongoing">Ongoing</option>
                    <option value="completed">Completed</option>
                    <option value="postponed">Postponed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn" style="background: var(--success);">Update Score</button>
                <button type="button" class="btn" style="background: var(--gray);" onclick="closeScoreModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
// Create group match
document.querySelectorAll('.createMatchForm').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('{{ url_for("admin_create_group_match") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error creating match: ' + error);
        });
    });
});

// Update elimination status
function updateEliminationStatus(standingId, status) {
    const formData = new FormData();
    formData.append('standing_id', standingId);
    formData.append('status', status);
    
    fetch('{{ url_for("admin_update_elimination_status") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error updating status: ' + error);
    });
}

// Score modal functions
let currentMatchId = null;

function openScoreModal(matchId, homeScore, awayScore, status) {
    currentMatchId = matchId;
    document.getElementById('match_id').value = matchId;
    document.getElementById('home_score').value = homeScore;
    document.getElementById('away_score').value = awayScore;
    document.getElementById('match_status').value = status;
    document.getElementById('scoreModal').style.display = 'flex';
}

function closeScoreModal() {
    document.getElementById('scoreModal').style.display = 'none';
    currentMatchId = null;
}

// Update match score
document.getElementById('scoreForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('{{ url_for("admin_update_group_match_score", match_id=0) }}'.replace('0', currentMatchId), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeScoreModal();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error updating score: ' + error);
    });
});

// Close modal when clicking outside
document.getElementById('scoreModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeScoreModal();
    }
});
</script>
{% endblock %}